# frozen_string_literal: true

module QA
  RSpec.describe 'Govern', :runner, :external_api_calls,
    only: { pipeline: %i[staging staging-canary canary production] },
    product_group: :threat_insights, quarantine: {
      issue: 'https://gitlab.com/gitlab-org/gitlab/-/issues/432585',
      type: :investigating
    } do
    describe 'Vulnerability Report' do
      let(:vuln_name) { "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')" }

      let!(:sast_report) { File.join(EE::Runtime::Path.fixture('secure_premade_reports'), 'gl-sast-report.json') }

      let!(:project) do
        create(:project,
          name: 'explain-this-vulnerability',
          description: 'To check explain this vulnerability AI feature')
      end

      let!(:runner) do
        create(:project_runner, project: project, name: "runner-for-#{project.name}", tags: ['secure_report'])
      end

      let!(:ci_yaml) do
        <<~YAML
          sast:
            tags: [secure_report]
            only: null # Template defaults to feature branches only
            script:
              - echo "Skipped"
            artifacts:
              reports:
                sast: gl-sast-report.json
        YAML
      end

      let!(:ci_file) do
        {
          file_path: '.gitlab-ci.yml',
          content: ci_yaml
        }
      end

      let!(:sast_report_file) do
        {
          file_path: 'gl-sast-report.json',
          content: File.read(sast_report)
        }
      end

      before do
        Flow::Login.sign_in
        project.group.sandbox.visit!

        Page::Group::Menu.perform(&:go_to_general_settings)
        # Enable AI experimental features for the parent group
        Page::Group::Settings::General.perform(&:set_experimental_features_enabled)
        project.visit!
      end

      after do
        runner.remove_via_api!
      end

      it 'checks explain this vulnerability AI feature',
        testcase: 'https://gitlab.com/gitlab-org/gitlab/-/quality/test_cases/432438' do
        commit_test_sast_reports
        explain_this_vulnerability(vuln_name)
        Support::Retrier.retry_on_exception(max_attempts: 4, sleep_interval: 1,
          message: "Retry failed AI did not return expected response") do
          aggregate_failures do
            expect(page.has_content?('Response generated by AI')).to be true
            expect(page.has_content?('Vulnerability Description')).to be true
            expect(page.has_content?('Exploiting the Vulnerability')).to be true
            expect(page.has_content?('Fixing the Vulnerability')).to be true
          end
        end
      end

      def explain_this_vulnerability(vulnerability_name)
        Page::Project::Menu.perform(&:go_to_vulnerability_report)
        EE::Page::Project::Secure::SecurityDashboard.perform do |security_dashboard|
          security_dashboard.wait_for_vuln_report_to_load
          security_dashboard.click_vulnerability(description: vulnerability_name)
        end

        EE::Page::Project::Secure::VulnerabilityDetails.perform(&:explain_this_vulnerability)
      end

      def commit_test_sast_reports
        build(:commit,
          project: project,
          commit_message: 'Commit SAST report for testing') do |commit|
          commit.add_files([sast_report_file])
          commit.add_files([ci_file])
        end.fabricate_via_api!
      end
    end
  end
end
