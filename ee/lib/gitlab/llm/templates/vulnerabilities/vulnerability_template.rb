# frozen_string_literal: true

module Gitlab
  module Llm
    module Templates
      module Vulnerabilities
        class VulnerabilityTemplate
          include Gitlab::Utils::StrongMemoize

          MAX_CODE_LENGTH = 1_024

          def initialize(vulnerability, params = {})
            @vulnerability = vulnerability
            @params = params
          end

          private

          attr_reader :vulnerability

          delegate :title, :description, :file, to: :vulnerability
          delegate :source_code?, :vulnerable_code, to: :finding

          def identifiers
            finding.identifier_names.join(", ")
          end

          def finding
            vulnerability.finding
          end
          strong_memoize_attr :finding

          def filename
            File.basename(file)
          end

          def eligible_code?
            return false unless source_code?
            return false if vulnerable_code.length > MAX_CODE_LENGTH
            return false if vulnerability.secret_detection?

            true
          end
          strong_memoize_attr :eligible_code?
        end
      end
    end
  end
end
