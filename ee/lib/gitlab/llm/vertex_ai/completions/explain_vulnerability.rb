# frozen_string_literal: true

module Gitlab
  module Llm
    module VertexAi
      module Completions
        class ExplainVulnerability < Gitlab::Llm::Completions::Base
          DEFAULT_ERROR = 'An unexpected error has occurred.'

          def execute(user, vulnerability, options)
            unless vertex_ai?(vulnerability)
              return ::Gitlab::Llm::OpenAi::Completions::ExplainVulnerability
                .new(ai_prompt_class)
                .execute(user, vulnerability, options)
            end

            json = json_for(user, vulnerability)

            GraphqlTriggers.ai_completion_response(
              user.to_global_id,
              vulnerability.to_global_id,
              {
                id: SecureRandom.uuid,
                model_name: vulnerability.class.name,
                response_body: json.dig(:predictions, 0, :candidates, 0, :content),
                request_id: params[:request_id],
                errors: [json.dig(:error, :message)].compact
              }
            )
          rescue StandardError => error
            Gitlab::ErrorTracking.track_exception(error)

            ::Gitlab::Llm::OpenAi::ResponseService
              .new(user, vulnerability, { error: { message: DEFAULT_ERROR } }.to_json,
                options: { request_id: params[:request_id] })
              .execute
          end

          private

          def json_for(user, vulnerability)
            key = [vulnerability.cache_key, 'explain'].join('/')
            Rails.cache.fetch(key, expires_in: 5.minutes, skip_nil: true) do
              template = ai_prompt_class.new(vulnerability)
              Gitlab::Json.parse(response_for(user, template))
            end.with_indifferent_access
          end

          def response_for(user, template)
            client_class = ::Gitlab::Llm::VertexAi::Client
            client_class
              .new(user)
              .chat(content: template.to_prompt, **template.options(client_class))
          end

          def vertex_ai?(vulnerability)
            Feature.enabled?(:tofa_experimentation, vulnerability.project)
          end
        end
      end
    end
  end
end
