# frozen_string_literal: true

module Gitlab
  module VulnerabilityScanning
    class SecurityScanner
      EXTERNAL_ID = "gitlab-sbom-vulnerability-scanner"
      NAME = "GitLab SBoM Vulnerability Scanner"
      VENDOR = "GitLab"
      VERSION = "0.1.0"

      def self.fabricate
        new.scanner
      end

      def self.find_or_create_for_project!(project)
        unique_index = {
          project_id: project.id,
          external_id: EXTERNAL_ID
        }
        # rubocop: disable CodeReuse/ActiveRecord
        ::Vulnerabilities::Scanner.upsert(
          unique_index.merge({
            name: NAME,
            vendor: VENDOR
          }),
          unique_by: %i[project_id external_id]
        )
        ::Vulnerabilities::Scanner.find_by!(unique_index)
        # rubocop: enable CodeReuse/ActiveRecord
      end

      def scanner
        ::Gitlab::Ci::Reports::Security::Scanner.new(
          external_id: EXTERNAL_ID,
          name: NAME,
          vendor: VENDOR,
          version: VERSION)
      end
    end
  end
end
