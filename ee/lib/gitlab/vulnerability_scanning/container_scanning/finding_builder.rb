# frozen_string_literal: true

module Gitlab
  module VulnerabilityScanning
    module ContainerScanning
      class FindingBuilder < VulnerabilityScanning::FindingBuilder
        include Gitlab::Utils::StrongMemoize

        MissingPropertiesError = Class.new(StandardError)

        private

        def validate!
          return unless sbom_source.image_name.nil? || sbom_source.image_tag.nil?

          raise MissingPropertiesError,
            'Missing required gitlab:container_scanning CycloneDX properties'
        end

        def report_type
          "container_scanning"
        end

        def title
          advisory.title
        end
        strong_memoize_attr :title

        def details
          {
            vulnerable_package: {
              name: "Vulnerable Package",
              type: "text",
              value: "#{affected_component.name}:#{affected_component.version}"
            }
          }.with_indifferent_access.freeze
        end

        def image_and_tag
          "#{sbom_source.image_name}:#{sbom_source.image_tag}"
        end
        strong_memoize_attr :image_and_tag

        def operating_system_name_and_version
          "#{sbom_source.operating_system_name} #{sbom_source.operating_system_version}"
        end
        strong_memoize_attr :image_and_tag

        def location
          ::Gitlab::Ci::Reports::Security::Locations::ContainerScanning.new(
            image: image_and_tag,
            operating_system: operating_system_name_and_version,
            package_name: affected_component.name,
            package_version: affected_component.version
          )
        end
        strong_memoize_attr :location

        def original_data
          {
            message: title,
            description: advisory.description,
            solution: advisory.solution,
            location: {
              image: image_and_tag,
              operating_system: operating_system_name_and_version,
              dependency: {
                package: { name: affected_component.name },
                version: affected_component.version
              }
            }
          }.with_indifferent_access.freeze
        end
      end
    end
  end
end
