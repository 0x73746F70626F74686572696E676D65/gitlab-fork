<script>
import { PortalTarget } from 'portal-vue';
import findingsQuery from 'ee/security_dashboard/graphql/queries/pipeline_findings.query.graphql';
import VulnerabilityFilters from '../shared/vulnerability_report/vulnerability_filters.vue';
import VulnerabilityListGraphql from '../shared/vulnerability_report/vulnerability_list_graphql.vue';
import { FILTERS, FIELDS } from '../shared/vulnerability_report/constants';
import VulnerabilityFindingModal from './vulnerability_finding_modal.vue';

export default {
  components: {
    VulnerabilityFilters,
    VulnerabilityListGraphql,
    VulnerabilityFindingModal,
    PortalTarget,
  },
  data() {
    return {
      graphqlFilters: undefined,
      selectedFinding: undefined,
    };
  },
  methods: {
    // Two issues here for the pipeline GraphQL endpoint:
    // 1. Severity and reportType filters, unlike for vulnerabilities, need to be lower case.
    // 2. Empty array returns an empty result, so we need to pass undefined in that case.
    normalizeForGraphQLQuery(filter) {
      return filter?.length ? filter.map((s) => s.toLowerCase()) : undefined;
    },
    updateFilters(filters) {
      this.graphqlFilters = {
        ...filters,
        reportType: this.normalizeForGraphQLQuery(filters.reportType),
        severity: this.normalizeForGraphQLQuery(filters.severity),
      };
    },
    showModal(finding) {
      this.selectedFinding = finding;
    },
    hideModal() {
      this.selectedFinding = undefined;
    },
  },
  filtersToShow: [FILTERS.STATUS, FILTERS.SEVERITY, FILTERS.TOOL_SIMPLE],
  fieldsToShow: [
    FIELDS.CHECKBOX,
    FIELDS.STATUS,
    FIELDS.SEVERITY,
    FIELDS.DESCRIPTION,
    FIELDS.IDENTIFIER,
    FIELDS.TOOL,
  ],
  portalName: 'pipeline-security-tab-sticky',
  findingsQuery,
};
</script>

<template>
  <div>
    <div class="security-dashboard-filters gl-mt-7">
      <vulnerability-filters :filters="$options.filtersToShow" @filters-changed="updateFilters" />
      <portal-target :name="$options.portalName" />
    </div>

    <vulnerability-list-graphql
      :query="$options.findingsQuery"
      :fields="$options.fieldsToShow"
      :filters="graphqlFilters"
      :portal-name="$options.portalName"
      @vulnerability-clicked="showModal"
    />

    <vulnerability-finding-modal
      v-if="selectedFinding"
      :finding="selectedFinding"
      @hide="hideModal"
    />
  </div>
</template>
