<script>
import { GlFilteredSearch } from '@gitlab/ui';
import { OPERATORS_OR, OPERATOR_OR } from '~/vue_shared/components/filtered_search_bar/constants';
import StatusToken from './tokens/status_token.vue';
import SeverityToken from './tokens/severity_token.vue';
import ActivityToken from './tokens/activity_token.vue';
import eventHub from './event_hub';

export default {
  components: {
    GlFilteredSearch,
  },
  data() {
    const value = [
      {
        type: 'state',
        value: {
          data: StatusToken.DEFAULT_VALUES,
          operator: OPERATOR_OR,
        },
      },
      {
        type: 'activity',
        value: {
          data: ActivityToken.DEFAULT_VALUES,
          operator: OPERATOR_OR,
        },
      },
    ];

    if (this.$route.query.severity) {
      value.push({
        type: 'severity',
        value: {
          data: this.$route.query.severity.split(','),
          operator: OPERATOR_OR,
        },
      });
    }

    return {
      value,
    };
  },
  computed: {
    tokens() {
      return [
        {
          type: 'state',
          title: StatusToken.i18n.statusLabel,
          multiSelect: true,
          unique: true,
          token: StatusToken,
          operators: OPERATORS_OR,
        },
        {
          type: 'activity',
          title: ActivityToken.i18n.label,
          multiSelect: true,
          unique: true,
          token: ActivityToken,
          operators: OPERATORS_OR,
        },
        {
          type: 'severity',
          title: SeverityToken.i18n.label,
          multiSelect: true,
          unique: true,
          token: SeverityToken,
          operators: OPERATORS_OR,
        },
      ];
    },
  },
  created() {
    eventHub.$on('filters-changed', (args) => {
      this.$emit('filters-changed', args);
    });
  },
};
</script>

<template>
  <gl-filtered-search
    :placeholder="s__('Vulnerability|Search or filter vulnerabilities...')"
    :available-tokens="tokens"
    :value="value"
    terms-as-tokens
    @clear="$emit('filters-changed', {})"
  />
</template>
