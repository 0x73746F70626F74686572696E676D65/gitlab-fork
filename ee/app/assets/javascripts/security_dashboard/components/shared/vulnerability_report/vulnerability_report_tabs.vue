<script>
import { GlTabs, GlCard } from '@gitlab/ui';
import { s__ } from '~/locale';
import SurveyRequestBanner from '../survey_request_banner.vue';
import VulnerabilityReportHeader from './vulnerability_report_header.vue';
import VulnerabilityReportTab from './vulnerability_report_tab.vue';
import { REPORT_TAB } from './constants';

const DEVELOPMENT_TAB_INDEX = 0;
const OPERATIONAL_TAB_INDEX = 1;

export default {
  components: {
    GlTabs,
    GlCard,
    SurveyRequestBanner,
    VulnerabilityReportHeader,
    VulnerabilityReportTab,
  },
  props: {
    query: {
      type: Object,
      required: true,
    },
    showProjectFilter: {
      type: Boolean,
      required: false,
      default: false,
    },
  },
  data() {
    return {
      tabIndex: this.$route.query.tab === REPORT_TAB.OPERATIONAL ? OPERATIONAL_TAB_INDEX : 0,
    };
  },
  watch: {
    tabIndex(index) {
      // Set tab querystring value to 'OPERATIONAL' if it's the operational tab, otherwise remove it
      // for the development tab.
      const query = {
        ...this.$route.query,
        tab: index === OPERATIONAL_TAB_INDEX ? REPORT_TAB.OPERATIONAL : undefined,
        // Reset pagination when the tab is changed.
        before: undefined,
        after: undefined,
      };

      this.$router.push({ query });
    },
  },
  i18n: {
    developmentTab: s__('SecurityReports|Development vulnerabilities'),
    operationalTab: s__('SecurityReports|Operational vulnerabilities'),
    operationalTabMessage: s__(
      'SecurityReports|These vulnerabilities were detected in external sources. They are not necessarily tied to your GitLab project. For example, running containers, URLs, and so on.',
    ),
  },
  REPORT_TAB,
  DEVELOPMENT_TAB_INDEX,
  OPERATIONAL_TAB_INDEX,
};
</script>

<template>
  <div>
    <survey-request-banner class="gl-mt-5" />

    <vulnerability-report-header />

    <gl-tabs v-model="tabIndex" class="gl-mt-5" content-class="gl-pt-0">
      <vulnerability-report-tab
        :title="$options.i18n.developmentTab"
        :type="$options.REPORT_TAB.DEVELOPMENT"
        :query="query"
        :show-project-filter="showProjectFilter"
        :is-active="tabIndex === $options.DEVELOPMENT_TAB_INDEX"
      >
        <template #header>
          <slot name="header-development"></slot>
        </template>
      </vulnerability-report-tab>

      <vulnerability-report-tab
        :title="$options.i18n.operationalTab"
        :type="$options.REPORT_TAB.OPERATIONAL"
        :query="query"
        :show-project-filter="showProjectFilter"
        :is-active="tabIndex === $options.OPERATIONAL_TAB_INDEX"
      >
        <template #header>
          <gl-card body-class="gl-p-6">{{ $options.i18n.operationalTabMessage }}</gl-card>
        </template>
      </vulnerability-report-tab>
    </gl-tabs>
  </div>
</template>
