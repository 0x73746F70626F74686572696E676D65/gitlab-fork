<script>
import { GlTabs, GlTab, GlCard, GlBadge } from '@gitlab/ui';
import { sumBy } from 'lodash';
import { s__ } from '~/locale';
import SurveyRequestBanner from '../survey_request_banner.vue';
import VulnerabilityReportHeader from './vulnerability_report_header.vue';
import VulnerabilityReport from './vulnerability_report.vue';
import { REPORT_TAB } from './constants';

const DEVELOPMENT_TAB_INDEX = 0;
const OPERATIONAL_TAB_INDEX = 1;

export default {
  components: {
    GlTabs,
    GlTab,
    GlCard,
    GlBadge,
    SurveyRequestBanner,
    VulnerabilityReportHeader,
    VulnerabilityReport,
  },
  props: {
    query: {
      type: Object,
      required: true,
    },
    showProjectFilter: {
      type: Boolean,
      required: false,
      default: false,
    },
  },
  data() {
    return {
      developmentCounts: undefined,
      operationalCounts: undefined,
      tabIndex: this.$route.query.tab === REPORT_TAB.OPERATIONAL ? OPERATIONAL_TAB_INDEX : 0,
    };
  },
  watch: {
    tabIndex(index) {
      // Set tab querystring value to 'OPERATIONAL' if it's the operational tab, otherwise remove it
      // for the development tab.
      const query = {
        ...this.$route.query,
        tab: index === OPERATIONAL_TAB_INDEX ? REPORT_TAB.OPERATIONAL : undefined,
        // Reset pagination when the tab is changed.
        before: undefined,
        after: undefined,
      };

      this.$router.push({ query });
    },
  },
  methods: {
    updateDevelopmentCounts(counts) {
      this.developmentCounts = sumBy(counts, (x) => x.count);
    },
    updateOperationalCounts(counts) {
      this.operationalCounts = sumBy(counts, (x) => x.count);
    },
  },
  i18n: {
    developmentTab: s__('SecurityReports|Development vulnerabilities'),
    operationalTab: s__('SecurityReports|Operational vulnerabilities'),
    operationalTabMessage: s__(
      'SecurityReports|These vulnerabilities were detected in external sources. They are not necessarily tied to your GitLab project. For example, running containers, URLs, and so on.',
    ),
  },
  REPORT_TAB,
  DEVELOPMENT_TAB_INDEX,
  OPERATIONAL_TAB_INDEX,
};
</script>

<template>
  <div>
    <survey-request-banner class="gl-mt-5" />

    <vulnerability-report-header />

    <gl-tabs v-model="tabIndex" class="gl-mt-5" content-class="gl-pt-0">
      <gl-tab>
        <template #title>
          <span data-testid="tab-header-development">{{ $options.i18n.developmentTab }}</span>
          <gl-badge size="sm" class="gl-tab-counter-badge">
            <span>{{ developmentCounts }}</span>
          </gl-badge>
        </template>

        <slot name="header-development"></slot>

        <vulnerability-report
          :is-active="tabIndex === $options.DEVELOPMENT_TAB_INDEX"
          :type="$options.REPORT_TAB.DEVELOPMENT"
          :query="query"
          :show-project-filter="showProjectFilter"
          @counts-changed="updateDevelopmentCounts"
        />
      </gl-tab>

      <gl-tab>
        <template #title>
          <span data-testid="tab-header-operational">{{ $options.i18n.operationalTab }}</span>
          <gl-badge size="sm" class="gl-tab-counter-badge">
            <span>{{ operationalCounts }}</span>
          </gl-badge>
        </template>

        <gl-card body-class="gl-p-6">{{ $options.i18n.operationalTabMessage }}</gl-card>

        <slot name="header-operational"></slot>

        <vulnerability-report
          :is-active="tabIndex === $options.OPERATIONAL_TAB_INDEX"
          :type="$options.REPORT_TAB.OPERATIONAL"
          :query="query"
          :show-project-filter="showProjectFilter"
          @counts-changed="updateOperationalCounts"
        />
      </gl-tab>
    </gl-tabs>
  </div>
</template>
