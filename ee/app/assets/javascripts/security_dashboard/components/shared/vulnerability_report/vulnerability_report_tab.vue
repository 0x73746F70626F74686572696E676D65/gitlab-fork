<script>
import { GlTab, GlBadge } from '@gitlab/ui';
import { SEVERITY_COUNT_LIMIT } from '~/vulnerabilities/constants';
import VulnerabilityReport from './vulnerability_report.vue';

export default {
  components: { GlTab, GlBadge, VulnerabilityReport },
  props: {
    title: {
      type: String,
      required: true,
    },
    isActiveTab: {
      type: Boolean,
      required: true,
    },
    filterDropdowns: {
      type: Array,
      required: true,
    },
    fields: {
      type: Array,
      required: true,
    },
    filterFn: {
      type: Function,
      required: false,
      default: (filters) => filters,
    },
  },
  data() {
    return {
      counts: [],
      isCapped: false,
    };
  },
  computed: {
    countsSum() {
      const hasCapped = this.counts.some(({ count }) => count > SEVERITY_COUNT_LIMIT);

      if (hasCapped) {
        return `${SEVERITY_COUNT_LIMIT}+`;
      }

      return this.counts.reduce((sum, { count }) => sum + count, 0);
    },
  },
  methods: {
    updateCounts(counts) {
      this.counts = counts;
    },
  },
};
</script>

<template>
  <gl-tab>
    <template #title>
      <span>{{ title }}</span>
      <gl-badge size="sm" class="gl-tab-counter-badge">{{ countsSum }}</gl-badge>
    </template>

    <slot name="header"></slot>

    <vulnerability-report
      class="gl-mt-7"
      :is-visible="isActiveTab"
      :filter-dropdowns="filterDropdowns"
      :fields="fields"
      :filter-fn="filterFn"
      show-counts
      @counts-changed="updateCounts"
    />
  </gl-tab>
</template>
