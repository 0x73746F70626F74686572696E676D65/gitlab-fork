<script>
import { GlIntersectionObserver, GlLoadingIcon } from '@gitlab/ui';
import produce from 'immer';
import countsQuery from 'ee/security_dashboard/graphql/queries/vulnerability_severities_count.query.graphql';
import vulnerabilitiesQuery from 'ee/security_dashboard/graphql/queries/group_vulnerabilities.query.graphql';
import createFlash from '~/flash';
import { s__ } from '~/locale';
import DashboardNotConfiguredGroup from '../shared/empty_states/group_dashboard_not_configured.vue';
import VulnerabilityCounts from '../shared/vulnerability_report/vulnerability_counts.vue';
import VulnerabilityList from '../shared/vulnerability_report/vulnerability_list.vue';
import VulnerabilityFilters from '../shared/vulnerability_report/vulnerability_filters.vue';
import { FIELDS, FILTERS } from '../shared/vulnerability_report/constants';

export default {
  components: {
    VulnerabilityCounts,
    VulnerabilityList,
    VulnerabilityFilters,
    GlIntersectionObserver,
    GlLoadingIcon,
    DashboardNotConfiguredGroup,
  },
  inject: ['groupFullPath', 'canViewFalsePositive', 'canAdminVulnerability', 'hasProjects'],
  data() {
    return {
      counts: {},
      vulnerabilities: [],
      filters: [],
      sort: undefined,
      pageInfo: undefined,
    };
  },
  apollo: {
    counts: {
      query: countsQuery,
      errorPolicy: 'none',
      variables() {
        return {
          fullPath: this.groupFullPath,
          isGroup: true,
          ...this.filters,
        };
      },
      update({ group }) {
        return group.vulnerabilitySeveritiesCount;
      },
      error() {
        createFlash({
          message: s__(
            'SecurityReports|Error fetching the vulnerability counts. Please check your network connection and try again.',
          ),
        });
      },
    },
    vulnerabilities: {
      query: vulnerabilitiesQuery,
      errorPolicy: 'none',
      variables() {
        return {
          fullPath: this.groupFullPath,
          sort: this.sort,
          vetEnabled: this.canViewFalsePositive,
          ...this.filters,
        };
      },
      update({ group }) {
        this.pageInfo = group.vulnerabilities.pageInfo;
        return group.vulnerabilities.nodes;
      },
      error() {
        createFlash({
          message: s__(
            'SecurityReports|Error fetching the vulnerability list. Please check your network connection and try again.',
          ),
        });
      },
    },
  },
  computed: {
    isLoadingCounts() {
      return this.$apollo.queries.counts.loading;
    },
    // Used to show the loading icon at the bottom of the vulnerabilities list.
    isLoadingVulnerabilities() {
      return this.$apollo.queries.vulnerabilities.loading;
    },
    // Used to show the initial skeleton loader for the vulnerabilities list.
    isLoadingInitialVulnerabilities() {
      return this.isLoadingVulnerabilities && this.vulnerabilities.length <= 0;
    },
    hasNextPage() {
      return this.pageInfo?.hasNextPage;
    },
    fields() {
      return [
        // Add the checkbox field if the user can use the bulk select feature.
        ...[this.canAdminVulnerability ? FIELDS.CHECKBOX : []],
        FIELDS.DETECTED,
        FIELDS.STATUS,
        FIELDS.SEVERITY,
        FIELDS.DESCRIPTION,
        FIELDS.IDENTIFIER,
        FIELDS.TOOL,
        FIELDS.ACTIVITY,
      ];
    },
  },
  methods: {
    updateSort(sort) {
      // Clear out the vulnerabilities so that the skeleton loader is shown.
      this.vulnerabilities = [];
      this.sort = sort;
    },
    updateFilters(filters) {
      // Clear out the vulnerabilities so that the skeleton loader is shown.
      this.vulnerabilities = [];
      this.filters = filters;
    },
    fetchNextPage() {
      this.$apollo.queries.vulnerabilities.fetchMore({
        variables: { after: this.pageInfo.endCursor },
        updateQuery: (previousResult, { fetchMoreResult }) => {
          return produce(fetchMoreResult, (draftData) => {
            draftData.group.vulnerabilities.nodes = [
              ...previousResult.group.vulnerabilities.nodes,
              ...draftData.group.vulnerabilities.nodes,
            ];
          });
        },
      });
    },
  },
  filtersToShow: [
    FILTERS.STATUS,
    FILTERS.SEVERITY,
    FILTERS.TOOL_SIMPLE,
    FILTERS.ACTIVITY,
    FILTERS.PROJECT,
  ],
};
</script>

<template>
  <dashboard-not-configured-group v-if="!hasProjects" />

  <div v-else class="gl-mt-5">
    <vulnerability-counts :counts="counts" :is-loading="isLoadingCounts" />

    <vulnerability-filters
      :filters="$options.filtersToShow"
      class="security-dashboard-filters gl-mt-7"
      @filters-changed="updateFilters"
    />

    <vulnerability-list
      class="gl-mt-5"
      :is-loading="isLoadingInitialVulnerabilities"
      :vulnerabilities="vulnerabilities"
      :fields="fields"
      should-show-project-namespace
      @sort-changed="updateSort"
    />

    <gl-intersection-observer v-if="hasNextPage" @appear="fetchNextPage">
      <gl-loading-icon v-if="isLoadingVulnerabilities" size="md" />
    </gl-intersection-observer>
  </div>
</template>
