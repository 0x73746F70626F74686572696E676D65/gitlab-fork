<script>
import { EDITOR_MODE_RULE, EDITOR_MODE_YAML, PARSING_ERROR_MESSAGE } from '../constants';
import EditorLayout from '../editor_layout.vue';
import { DEFAULT_VULNERABILITY_MANAGEMENT_POLICY } from './constants';
import { createPolicyObject, policyToYaml } from './utils';

export default {
  EDITOR_MODE_RULE,
  EDITOR_MODE_YAML,
  components: {
    EditorLayout,
  },
  inject: ['namespacePath'],
  props: {
    assignedPolicyProject: {
      type: Object,
      required: true,
    },
    existingPolicy: {
      type: Object,
      required: false,
      default: null,
    },
    isEditing: {
      type: Boolean,
      required: false,
      default: false,
    },
  },
  data() {
    let yamlEditorValue;

    if (this.existingPolicy) {
      yamlEditorValue = policyToYaml(this.existingPolicy);
    } else {
      yamlEditorValue = DEFAULT_VULNERABILITY_MANAGEMENT_POLICY;
    }

    const { policy, hasParsingError } = createPolicyObject(yamlEditorValue);
    const parsingError = hasParsingError ? PARSING_ERROR_MESSAGE : '';

    return {
      mode: EDITOR_MODE_RULE,
      policy,
      yamlEditorValue,
      isUpdatingPolicy: false,
      isRemovingPolicy: false,
      hasParsingError,
      parsingError,
    };
  },
  methods: {
    changeEditorMode(mode) {
      this.mode = mode;
    },
    handleUpdateProperty(property, value) {
      this.policy[property] = value;
      this.updateYamlEditorValue(this.policy);
    },
    handleUpdateYaml(manifest) {
      const { policy, hasParsingError } = createPolicyObject(manifest);

      this.yamlEditorValue = manifest;
      this.hasParsingError = hasParsingError;
      this.parsingError = hasParsingError ? PARSING_ERROR_MESSAGE : '';
      this.policy = policy;
    },
    updateYamlEditorValue(policy) {
      this.yamlEditorValue = policyToYaml(policy);
    },
  },
};
</script>
<template>
  <editor-layout
    :policy="policy"
    :yaml-editor-value="yamlEditorValue"
    :is-editing="isEditing"
    :is-removing-policy="isRemovingPolicy"
    :is-updating-policy="isUpdatingPolicy"
    :has-parsing-error="hasParsingError"
    :parsing-error="parsingError"
    @update-editor-mode="changeEditorMode"
    @update-property="handleUpdateProperty"
    @update-yaml="handleUpdateYaml"
  />
</template>
