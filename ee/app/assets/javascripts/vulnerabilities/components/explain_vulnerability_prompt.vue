<script>
import { GlAccordion, GlAccordionItem, GlSkeletonLoader, GlAlert } from '@gitlab/ui';
import { s__ } from '~/locale';
import explainVulnerabilityPromptQuery from 'ee/security_dashboard/graphql/queries/explain_vulnerability_prompt.query.graphql';
import CodeBlock from '~/vue_shared/components/code_block.vue';

export default {
  components: {
    GlAccordion,
    GlAccordionItem,
    CodeBlock,
    GlSkeletonLoader,
    GlAlert,
  },
  props: {
    vulnerabilityGraphqlId: { type: String, required: true },
  },
  data() {
    return {
      prompts: null,
      loadingError: false,
      promptVisible: false,
    };
  },
  apollo: {
    prompts: {
      query: explainVulnerabilityPromptQuery,
      variables() {
        return { id: this.vulnerabilityGraphqlId };
      },
      update(data) {
        return data.explainVulnerabilityPrompt;
      },
      error() {
        this.loadingError = true;
      },
    },
  },
  computed: {
    prompt() {
      return this.prompts?.promptWithCode || this.prompts?.promptWithoutCode;
    },
    accordionText() {
      return this.promptVisible ? this.$options.i18n.hidePrompt : this.$options.i18n.showPrompt;
    },
  },
  i18n: {
    showPrompt: s__('Vulnerability|Show prompt'),
    hidePrompt: s__('Vulnerability|Hide prompt'),
    requestError: s__('Vulnerability|Could not load prompt.'),
  },
};
</script>

<template>
  <gl-accordion :header-level="3" class="gl-mb-4">
    <gl-accordion-item v-model="promptVisible" :title="accordionText">
      <code-block
        v-if="$apollo.queries.prompts.loading"
        class="gl-px-4 gl-pt-4 gl-pb-3"
        data-testid="loading-block"
      >
        <gl-skeleton-loader />
      </code-block>
      <gl-alert v-else-if="loadingError" variant="danger" :dismissible="false">
        {{ $options.i18n.requestError }}
      </gl-alert>
      <code-block v-else class="gl-px-4 gl-py-3" data-testid="prompt-block">{{
        prompt
      }}</code-block>
    </gl-accordion-item>
  </gl-accordion>
</template>
