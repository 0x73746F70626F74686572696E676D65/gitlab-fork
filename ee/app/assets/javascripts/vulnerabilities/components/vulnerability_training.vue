<script>
import { GlLink, GlIcon, GlSkeletonLoader } from '@gitlab/ui';
import * as Sentry from '@sentry/browser';
import { s__, __ } from '~/locale';
import securityTrainingProvidersQuery from '~/security_configuration/graphql/security_training_providers.query.graphql';
import securityTrainingVulnerabilityQuery from '~/security_configuration/graphql/security_training_vulnerability.query.graphql';
import { TYPE_VULNERABILITY } from '~/graphql_shared/constants';
import { convertToGraphQLId } from '~/graphql_shared/utils';
import glFeatureFlagsMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import Tracking from '~/tracking';
import { TRACK_CLICK_TRAINING_LINK_ACTION } from '~/security_configuration/constants';
import { SUPPORTED_IDENTIFIER_TYPES, SECURITY_TRAINING_URL_STATUS_COMPLETED } from '../constants';

export const i18n = {
  trainingDescription: s__(
    'Vulnerability|Learn more about this vulnerability and the best way to resolve it.',
  ),
  trainingUnavailable: s__('Vulnerability|Training not available for this vulnerability.'),
  viewTraining: s__('Vulnerability|View training'),
  loading: __('Loading'),
};

export default {
  i18n,
  components: {
    GlLink,
    GlIcon,
    GlSkeletonLoader,
  },
  mixins: [glFeatureFlagsMixin(), Tracking.mixin()],
  inject: ['projectFullPath'],
  props: {
    id: {
      type: Number,
      required: true,
    },
  },
  apollo: {
    securityTrainingProviders: {
      query: securityTrainingProvidersQuery,
      update({ project }) {
        return project?.securityTrainingProviders;
      },
      error(e) {
        Sentry.captureException(e);
      },
      variables() {
        return {
          fullPath: this.projectFullPath,
        };
      },
    },
    vulnerability: {
      query: securityTrainingVulnerabilityQuery,
      update({ vulnerability }) {
        const allUrlsAreReady = vulnerability?.securityTrainingUrls?.every(
          ({ status }) => status === SECURITY_TRAINING_URL_STATUS_COMPLETED,
        );

        if (allUrlsAreReady) {
          // note: once we add polling, we can call `.stopPolling` here
          this.isUrlsLoading = false;
        }

        return vulnerability;
      },
      variables() {
        return { id: convertToGraphQLId(TYPE_VULNERABILITY, this.id) };
      },
      error(e) {
        Sentry.captureException(e);
      },
    },
  },
  data() {
    return {
      securityTrainingProviders: [],
      vulnerability: {},
      training: null,
      isUrlsLoading: true,
    };
  },
  computed: {
    showVulnerabilityTraining() {
      return Boolean(
        this.glFeatures.secureVulnerabilityTraining && this.hasSecurityTrainingProviders,
      );
    },
    showTrainingNotFound() {
      return !this.hasSupportedIdentifier || !this.hasSecurityTrainingUrls;
    },
    hasSecurityTrainingProviders() {
      return this.securityTrainingProviders?.some(({ isEnabled }) => isEnabled);
    },
    hasSupportedIdentifier() {
      return this.vulnerability?.identifiers?.some(
        ({ externalType }) => externalType?.toLowerCase() === SUPPORTED_IDENTIFIER_TYPES.cwe,
      );
    },
    hasSecurityTrainingUrls() {
      return this.vulnerability?.securityTrainingUrls?.length > 0;
    },
    securityTrainingUrls() {
      return this.vulnerability?.securityTrainingUrls;
    },
  },
  watch: {
    showVulnerabilityTraining: {
      immediate: true,
      handler(showVulnerabilityTraining) {
        this.$emit('show-vulnerability-training', showVulnerabilityTraining);
      },
    },
  },
  methods: {
    clickTrainingLink(name, url) {
      this.triggerMetric(TRACK_CLICK_TRAINING_LINK_ACTION, name, url);
    },
    triggerMetric(action, name, url) {
      this.track(action, {
        property: url,
        label: `vendor_${name}`,
      });
    },
  },
};
</script>

<template>
  <div v-if="showVulnerabilityTraining">
    <slot name="header"></slot>
    <p class="gl-text-gray-600!" data-testid="description">
      {{ $options.i18n.trainingDescription }}
    </p>
    <p v-if="showTrainingNotFound" data-testid="unavailable-message">
      {{ $options.i18n.trainingUnavailable }}
    </p>
    <div v-else-if="isUrlsLoading">
      <gl-skeleton-loader :width="200" :lines="3" />
    </div>
    <div v-else>
      <div v-for="({ name, url }, index) in securityTrainingUrls" :key="index" class="gl-mt-6">
        <div>
          <span class="gl-font-weight-bold gl-font-base">{{ name }}</span>
        </div>
        <gl-link :href="url" target="_blank" @click="clickTrainingLink(name, url)">
          {{ $options.i18n.viewTraining }}
          <gl-icon class="gl-ml-2" name="external-link" :size="12" />
        </gl-link>
      </div>
    </div>
  </div>
</template>
