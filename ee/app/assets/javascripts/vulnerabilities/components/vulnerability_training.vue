<script>
import { GlLink, GlIcon, GlSkeletonLoader } from '@gitlab/ui';
import * as Sentry from '@sentry/browser';
import { s__, __ } from '~/locale';
import securityTrainingProvidersQuery from '~/security_configuration/graphql/security_training_providers.query.graphql';
import glFeatureFlagsMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import axios from '~/lib/utils/axios_utils';
import Tracking from '~/tracking';
import {
  TRACK_CLICK_TRAINING_LINK_ACTION,
  TRACK_TRAINING_LOADED_ACTION,
} from '~/security_configuration/constants';
import { SUPPORTED_IDENTIFIER_TYPES } from '../constants';

export const i18n = {
  trainingDescription: s__(
    'Vulnerability|Learn more about this vulnerability and the best way to resolve it.',
  ),
  trainingUnavailable: s__('Vulnerability|Training not available for this vulnerability.'),
  viewTraining: s__('Vulnerability|View training'),
  loading: __('Loading'),
};

export const mockProvider = {
  path: 'https://integration-api.securecodewarrior.com/api/v1/trial',
  id: 'gitlab',
  name: s__('Vulnerability|Secure Code Warrior'),
};

export default {
  i18n,
  components: {
    GlLink,
    GlIcon,
    GlSkeletonLoader,
  },
  mixins: [glFeatureFlagsMixin(), Tracking.mixin()],
  inject: ['projectFullPath'],
  props: {
    identifiers: {
      type: Array,
      required: true,
    },
  },
  apollo: {
    securityTrainingProviders: {
      query: securityTrainingProvidersQuery,
      update({ project }) {
        return project?.securityTrainingProviders;
      },
      error(e) {
        Sentry.captureException(e);
      },
      variables() {
        return {
          fullPath: this.projectFullPath,
        };
      },
    },
  },
  data() {
    return {
      securityTrainingProviders: [],
      training: null,
      isLoading: true,
      hasError: false,
    };
  },
  computed: {
    showVulnerabilityTraining() {
      return Boolean(
        this.glFeatures.secureVulnerabilityTraining &&
          this.enabledSecurityTrainingProviders?.length &&
          this.identifiers?.length,
      );
    },
    enabledSecurityTrainingProviders() {
      return this.securityTrainingProviders?.filter((provider) => provider.isEnabled);
    },
    supportedIdentifier() {
      return this.identifiers?.find(
        ({ externalType }) => externalType?.toLowerCase() === SUPPORTED_IDENTIFIER_TYPES.cwe,
      );
    },
    showTrainingNotFound() {
      return !this.supportedIdentifier || this.hasError;
    },
  },
  watch: {
    showVulnerabilityTraining: {
      immediate: true,
      handler(showVulnerabilityTraining) {
        this.$emit('show-vulnerability-training', showVulnerabilityTraining);
      },
    },
    supportedIdentifier: {
      immediate: true,
      handler(supportedIdentifier) {
        if (supportedIdentifier) {
          const { externalType, externalId } = supportedIdentifier;
          this.fetchTraining(externalType, externalId);
        } else {
          this.isLoading = false;
        }
      },
    },
  },
  methods: {
    async fetchTraining(mappingList, mappingKey) {
      const { path, id, name } = mockProvider;
      const params = {
        id,
        mappingList,
        mappingKey,
      };

      try {
        const {
          data: { url },
        } = await axios.get(path, { params });
        this.triggerMetric(TRACK_TRAINING_LOADED_ACTION);
        this.training = { name, url };
      } catch {
        this.hasError = true;
      } finally {
        this.isLoading = false;
      }
    },
    clickTrainingLink() {
      this.triggerMetric(TRACK_CLICK_TRAINING_LINK_ACTION);
    },
    triggerMetric(action) {
      const { name } = this.supportedIdentifier;
      const { id } = mockProvider;

      this.track(action, {
        label: `vendor_${id}`,
        property: name,
      });
    },
  },
};
</script>

<template>
  <div v-if="showVulnerabilityTraining">
    <slot name="header"></slot>
    <p class="gl-text-gray-600!" data-testid="description">
      {{ $options.i18n.trainingDescription }}
    </p>
    <p v-if="showTrainingNotFound" data-testid="unavailable-message">
      {{ $options.i18n.trainingUnavailable }}
    </p>
    <div v-else-if="isLoading">
      <gl-skeleton-loader :width="200" :lines="3" />
    </div>
    <div v-else>
      <div class="gl-font-weight-bold gl-font-base">{{ training.name }}</div>
      <gl-link :href="training.url" target="_blank" @click="clickTrainingLink">
        {{ $options.i18n.viewTraining }}
        <gl-icon class="gl-ml-2" name="external-link" :size="12" />
      </gl-link>
    </div>
  </div>
</template>
