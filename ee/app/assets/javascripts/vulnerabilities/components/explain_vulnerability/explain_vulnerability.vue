<script>
import { GlSprintf, GlButton, GlLink, GlIcon } from '@gitlab/ui';
import { s__ } from '~/locale';
import { helpPagePath } from '~/helpers/help_page_helper';
import { convertToGraphQLId } from '~/graphql_shared/utils';
import { TYPENAME_VULNERABILITY } from '~/graphql_shared/constants';
import chatMutation from 'ee/ai/graphql/chat.mutation.graphql';
import { helpCenterState } from '~/super_sidebar/constants';

export default {
  components: {
    GlSprintf,
    GlButton,
    GlLink,
    GlIcon,
  },
  props: {
    vulnerabilityId: { type: [Number, String], required: true },
  },
  infoHelpLink: helpPagePath('/user/application_security/vulnerabilities/index.md', {
    anchor: 'explaining-a-vulnerability',
  }),
  explainVulnerabilityMessage: s__('Vulnerability|You can also %{message}.'),
  computed: {
    vulnerabilityGraphqlId() {
      return convertToGraphQLId(TYPENAME_VULNERABILITY, this.vulnerabilityId);
    },
  },
  methods: {
    triggerDuoChat() {
      helpCenterState.showTanukiBotChatDrawer = true;

      this.$apollo.mutate({
        mutation: chatMutation,
        variables: {
          question: '/vulnerability_explain',
          resourceId: this.vulnerabilityGraphqlId,
        },
      });
    },
  },
};
</script>

<template>
  <div class="gl-flex">
    <gl-sprintf :message="$options.explainVulnerabilityMessage">
      <template #message>
        <gl-button
          class="gl-ml-2"
          data-testid="explain-vulnerability-button"
          variant="link"
          @click="triggerDuoChat"
        >
          {{
            s__(
              'Vulnerability|use AI by asking GitLab Duo Chat to explain this vulnerability and suggest a solution',
            )
          }}
        </gl-button>
      </template>
    </gl-sprintf>
    <gl-link :href="$options.infoHelpLink" class="gl-text-gray-500"
      ><gl-icon name="information-o" class="gl-ml-2"
    /></gl-link>
  </div>
</template>
