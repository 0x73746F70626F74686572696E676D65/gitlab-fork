<script>
import {
  GlCard,
  GlButton,
  GlDrawer,
  GlAlert,
  GlSprintf,
  GlLink,
  GlIcon,
  GlBadge,
  GlSkeletonLoader,
} from '@gitlab/ui';
import SafeHtml from '~/vue_shared/directives/safe_html';
import { DRAWER_Z_INDEX } from '~/lib/utils/constants';
import { getContentWrapperHeight } from '~/lib/utils/dom_utils';
import { s__, __ } from '~/locale';
import { getMarkdown } from '~/rest_api';
import { renderGFM } from '~/behaviors/markdown/render_gfm';
import aiResponseSubscription from 'ee/graphql_shared/subscriptions/ai_completion_response.subscription.graphql';
import aiActionMutation from 'ee/graphql_shared/mutations/ai_action.mutation.graphql';
import { convertToGraphQLId } from '~/graphql_shared/utils';
import { TYPENAME_USER, TYPENAME_VULNERABILITY } from '~/graphql_shared/constants';
import { helpPagePath } from '~/helpers/help_page_helper';
import ExplainVulnerabilityPrompt from './explain_vulnerability_prompt.vue';
import UserFeedback from './explain_this_vulnerability_user_feedback.vue';

export default {
  components: {
    GlCard,
    GlButton,
    GlDrawer,
    GlAlert,
    GlSprintf,
    GlLink,
    GlIcon,
    GlBadge,
    GlSkeletonLoader,
    UserFeedback,
    ExplainVulnerabilityPrompt,
  },
  directives: { SafeHtml },
  props: {
    vulnerability: { type: Object, required: true },
  },
  data() {
    return {
      isLoadingAiResponse: false,
      isLoadingPrompt: false,
      isDrawerOpen: false,
      markdown: '',
      hasError: false,
      includeSourceCode: false,
    };
  },
  apollo: {
    $subscribe: {
      aiCompletionResponse: {
        query: aiResponseSubscription,
        variables() {
          return {
            resourceId: this.vulnerabilityGraphqlId,
            userId: convertToGraphQLId(TYPENAME_USER, gon.current_user_id),
          };
        },
        async result({ data }) {
          // When we first subscribe, we will receive a null aiCompletionResponse. We do nothing in this case.
          const { errors = [], responseBody } = data.aiCompletionResponse || {};

          if (errors.length) {
            this.isLoadingAiResponse = false;
            this.showError();
          } else if (responseBody) {
            // Use the markdown REST API to format the text using GitLab's format.
            const markdownResponse = await getMarkdown({ text: responseBody, gfm: true });
            this.isLoadingAiResponse = false;
            this.markdown = markdownResponse.data.html;
            // Wait for the browser to render the markdown first. $nextTick doesn't work here because it's too fast.
            requestAnimationFrame(() => {
              // Use renderGFM() to add syntax highlighting to the markdown.
              renderGFM(this.$refs.markdown);
            });
          }
        },
        skip() {
          return !this.isLoadingAiResponse;
        },
      },
    },
  },
  computed: {
    getDrawerHeaderHeight() {
      return getContentWrapperHeight();
    },
    vulnerabilityGraphqlId() {
      return convertToGraphQLId(TYPENAME_VULNERABILITY, this.vulnerability.id);
    },
  },
  methods: {
    getExplanation() {
      this.isDrawerOpen = true;
      this.isLoadingAiResponse = true;
      this.hasError = false;
      this.markdown = '';

      this.$apollo
        .mutate({
          mutation: aiActionMutation,
          variables: {
            input: {
              explainVulnerability: {
                resourceId: this.vulnerabilityGraphqlId,
                includeSourceCode: this.includeSourceCode,
              },
            },
          },
        })
        .then(({ data }) => {
          if (data.aiAction.errors.length > 0) {
            this.showError();
          }
        })
        .catch(this.showError);
    },
    closeDrawer() {
      this.isDrawerOpen = false;
    },
    showError() {
      this.isLoadingAiResponse = false;
      this.hasError = true;
    },
    updateIsLoadingPrompt(isLoadingPrompt) {
      this.isLoadingPrompt = isLoadingPrompt;
    },
    updateIncludeSourceCode(includeSourceCode) {
      this.includeSourceCode = includeSourceCode;
    },
  },
  i18n: {
    cardTitle: s__('Vulnerability|Explain this vulnerability and how to mitigate it with AI'),
    cardText: s__(
      'Vulnerability|This is an experimental feature that uses AI to explain the vulnerability and provide recommendations. Use this feature with caution as we continue to iterate. Please provide your feedback and ideas in %{linkStart}this issue%{linkEnd}.',
    ),
    buttonText: s__('Vulnerability|Try it out'),
    drawerTitle: s__('Vulnerability|Explain this vulnerability'),
    drawerSubtitle: s__('Vulnerability|Response generated by AI'),
    experimentLabel: __('Experiment'),
    requestError: s__(
      'Vulnerability|There was an unexpected error. %{linkStart}Please try again%{linkEnd}.',
    ),
  },
  feedbackIssueHref: 'https://gitlab.com/gitlab-org/gitlab/-/issues/407295',
  experimentDocHref: helpPagePath('policy/experiment-beta-support', { anchor: 'experiment' }),
  DRAWER_Z_INDEX,
};
</script>

<template>
  <gl-card class="gl-banner-introduction gl-border-none!">
    <div class="gl-mb-3">
      <gl-icon name="tanuki-ai" class="gl-mr-2 gl-text-blue-600" />
      <span class="gl-font-weight-bold">{{ $options.i18n.cardTitle }}</span>
      <gl-badge variant="neutral" size="sm" class="gl-ml-2" :href="$options.experimentDocHref">
        {{ $options.i18n.experimentLabel }}
      </gl-badge>
    </div>
    <p class="gl-mb-3!">
      <gl-sprintf :message="$options.i18n.cardText">
        <template #link="{ content }">
          <gl-link :href="$options.feedbackIssueHref" target="_blank">{{ content }}</gl-link>
        </template>
      </gl-sprintf>
    </p>

    <explain-vulnerability-prompt
      :vulnerability-graphql-id="vulnerabilityGraphqlId"
      :is-drawer-open="isDrawerOpen"
      @loading-state-changed="updateIsLoadingPrompt"
      @checkbox-changed="updateIncludeSourceCode"
    />

    <gl-button
      variant="confirm"
      icon="tanuki-ai"
      :disabled="isDrawerOpen"
      :loading="isLoadingPrompt"
      data-testid="try-button"
      @click="getExplanation"
    >
      {{ $options.i18n.buttonText }}
    </gl-button>

    <gl-drawer
      :open="isDrawerOpen"
      :header-height="getDrawerHeaderHeight"
      header-sticky
      class="gl-reset-line-height"
      :z-index="$options.DRAWER_Z_INDEX"
      @close="closeDrawer"
    >
      <template #title>
        <div class="gl-display-flex gl-justify-content-start gl-align-items-center">
          <gl-icon name="tanuki-ai" class="gl-text-purple-600" />
          <span class="gl-font-size-markdown gl-font-weight-bold gl-mx-3">
            {{ $options.i18n.drawerTitle }}
          </span>
          <gl-badge variant="neutral">{{ $options.i18n.experimentLabel }}</gl-badge>
        </div>
      </template>

      <div class="gl-text-gray-500 gl-bg-gray-10 gl-border-none gl-text-center gl-p-4!">
        {{ $options.i18n.drawerSubtitle }}
      </div>

      <div class="gl-pt-4!">
        <div
          v-if="isLoadingAiResponse"
          class="gl-border-1 gl-border-gray-100 gl-border-solid gl-p-4 gl-rounded-base gl-bg-gray-10"
        >
          <gl-skeleton-loader :lines="4" />
        </div>
        <div v-else-if="hasError">
          <gl-alert variant="danger" :dismissible="false">
            <gl-sprintf :message="$options.i18n.requestError">
              <template #link="{ content }">
                <gl-button variant="link" @click="getExplanation">{{ content }}</gl-button>
              </template>
            </gl-sprintf>
          </gl-alert>
        </div>
        <div v-else ref="markdown" v-safe-html="markdown" data-testid="markdown"></div>
      </div>

      <template #footer>
        <user-feedback v-if="markdown" :vulnerability="vulnerability" />
      </template>
    </gl-drawer>
  </gl-card>
</template>
