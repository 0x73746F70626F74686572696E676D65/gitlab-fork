<script>
import {
  GlCard,
  GlButton,
  GlDrawer,
  GlLoadingIcon,
  GlAlert,
  GlSprintf,
  GlLink,
  GlIcon,
  GlBadge,
} from '@gitlab/ui';
import SafeHtml from '~/vue_shared/directives/safe_html';
import Api from 'ee/api';
import { getContentWrapperHeight } from '~/lib/utils/dom_utils';
import { DRAWER_CONTAINER_CLASS } from '~/ci/pipeline_editor/components/job_assistant_drawer/constants';
import { s__ } from '~/locale';
import { getMarkdown } from '~/rest_api';
import { renderGFM } from '~/behaviors/markdown/render_gfm';
import projectFileContentsQuery from './project_file_contents.query.graphql';

export default {
  components: {
    GlCard,
    GlButton,
    GlDrawer,
    GlLoadingIcon,
    GlAlert,
    GlSprintf,
    GlLink,
    GlIcon,
    GlBadge,
  },
  directives: { SafeHtml },
  props: {
    vulnerability: { type: Object, required: true },
  },
  data() {
    return {
      isLoading: false,
      isDrawerOpen: false,
      response: null,
      markdown: '',
      hasError: false,
    };
  },
  computed: {
    headerHeight() {
      return getContentWrapperHeight(DRAWER_CONTAINER_CLASS);
    },
    responseMessage() {
      return this.response?.choices?.[0]?.message?.content || '';
    },
  },
  methods: {
    async getExplanation() {
      this.isLoading = true;
      this.hasError = false;
      this.isDrawerOpen = true;

      try {
        const { title, description, location, identifiers, project } = this.vulnerability;

        let codeString = '';
        // -------------------------------------------------------------------------------------------------------------
        // Get file contents.
        // -------------------------------------------------------------------------------------------------------------
        if (location?.file) {
          const fileContentsResponse = await this.$apollo.query({
            query: projectFileContentsQuery,
            variables: { fullPath: project.fullPath.replace('/', ''), filePath: location.file },
          });

          const codeRawString =
            fileContentsResponse.data.project.repository.blobs.nodes[0]?.rawBlob || '';
          const codeLines = codeRawString.split('\n');
          const vulnerableCodeLines = codeLines.splice(
            location.startLine - 1,
            location.endLine ? location.endLine - location.startLine + 1 : 1,
          );

          codeString = vulnerableCodeLines.join('\n');
        }

        // -------------------------------------------------------------------------------------------------------------
        // Get ChatGPT response.
        // -------------------------------------------------------------------------------------------------------------
        const messageArray = [];

        const identifiersArray = identifiers?.map(({ name }) => name);
        const identifiersString = identifiersArray.length ? `${identifiersArray.join(', ')}: ` : '';
        const vulnInfoString = description ? `${title} - ${description}` : title;

        messageArray.push(`Explain the vulnerability "${identifiersString}${vulnInfoString}"`);

        const filename = location?.blobPath?.split('/')?.at(-1);
        if (filename && codeString) {
          messageArray.push(
            `for the file "${filename}" with this vulnerable code:\n\n\`\`\`\n${codeString}\n\`\`\`\n\n`,
          );
        } else if (filename) {
          messageArray.push(`for the file "${filename}".`);
        } else {
          messageArray.push('.');
        }

        messageArray.push(
          `Provide a code example with syntax highlighting on how to exploit the vulnerable code.`,
        );
        messageArray.push(
          `Provide a code example with syntax highlighting on how to fix the vulnerable code.`,
        );
        messageArray.push(`Provide the response in markdown format with headers.`);

        const aiChatResponse = await Api.requestAIChat({
          model: 'gpt-3.5-turbo',
          max_tokens: 3000,
          temperature: 0.85,
          messages: [
            {
              role: 'system',
              content: 'You are a software vulnerability developer.', // eslint-disable-line @gitlab/require-i18n-strings
            },
            {
              role: 'user',
              content: messageArray.join(' '),
            },
          ],
        });

        this.response = aiChatResponse.data;

        // -------------------------------------------------------------------------------------------------------------
        // Get Markdown response.
        // -------------------------------------------------------------------------------------------------------------
        const markdownResponse = await getMarkdown({ text: this.responseMessage, gfm: true });
        this.markdown = markdownResponse.data.html;

        // Can't use $nextTick because it's too fast, we need to wait for the browser to render the markdown instead.
        requestAnimationFrame(() => {
          renderGFM(this.$refs.markdown);
        });
      } catch (e) {
        this.hasError = true;
        throw e;
      } finally {
        this.isLoading = false;
      }
    },
    closeDrawer() {
      this.isDrawerOpen = false;
    },
  },
  i18n: {
    cardTitle: s__('Vulnerability|AI-Assisted Remediation'),
    cardText: s__(
      'Vulnerability|This is an experimental alpha feature that leverages a large language model to provide recommendations. Please use this with caution as we continue to iterate. To learn more about what we have planned, please check out %{linkStart}this issue%{linkEnd} and give us feedback.',
    ),
    drawerTitle: s__('Vulnerability|Explain this vulnerability'),
    experimentLabel: s__('Vulnerability|Experiment'),
    requestError: s__(
      'Vulnerability|There was an unexpected error. %{linkStart}Please try again%{linkEnd}.',
    ),
  },
  feedbackIssueHref: 'https://gitlab.com/gitlab-org/gitlab/-/issues/407295',
};
</script>

<template>
  <gl-card class="gl-banner-introduction gl-border-none!" body-class="gl-display-flex">
    <gl-icon name="information-o" class="gl-flex-shrink-0 gl-mr-5 gl-text-blue-600" />
    <div>
      <h5 class="gl-mb-3!">
        {{ $options.i18n.cardTitle }}
        <gl-badge variant="info" size="sm" class="gl-ml-3">
          {{ $options.i18n.experimentLabel }}
        </gl-badge>
      </h5>
      <p class="gl-mb-3!">
        <gl-sprintf :message="$options.i18n.cardText">
          <template #link="{ content }">
            <gl-link :href="$options.feedbackIssueHref" target="_blank">{{ content }}</gl-link>
          </template>
        </gl-sprintf>
      </p>
      <gl-button variant="confirm" :disabled="isDrawerOpen" @click="getExplanation">
        {{ $options.i18n.drawerTitle }}
      </gl-button>
    </div>

    <gl-drawer
      :open="isDrawerOpen"
      :header-height="headerHeight"
      header-sticky
      class="gl-reset-line-height"
      @close="closeDrawer"
    >
      <template #title>
        <h3 class="gl-mb-0!">{{ $options.i18n.drawerTitle }}</h3>
      </template>

      <gl-loading-icon v-if="isLoading" size="lg" class="gl-mt-6!" />
      <div v-else-if="hasError">
        <gl-alert variant="danger" :dismissible="false">
          <gl-sprintf :message="$options.i18n.requestError">
            <template #link="{ content }">
              <gl-button variant="link" @click="getExplanation">{{ content }}</gl-button>
            </template>
          </gl-sprintf>
        </gl-alert>
      </div>
      <div v-else ref="markdown" v-safe-html="markdown"></div>
    </gl-drawer>
  </gl-card>
</template>
