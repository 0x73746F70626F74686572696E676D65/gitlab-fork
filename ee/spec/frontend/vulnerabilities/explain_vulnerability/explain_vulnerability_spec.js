import Vue from 'vue';
import VueApollo from 'vue-apollo';
import { GlCard } from '@gitlab/ui';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import ExplainVulnerability from 'ee/vulnerabilities/components/explain_vulnerability/explain_vulnerability.vue';
import { helpCenterState } from '~/super_sidebar/constants';
import chatMutation from 'ee/ai/graphql/chat.mutation.graphql';
import createMockApollo from 'helpers/mock_apollo_helper';
import { MOCK_TANUKI_BOT_MUTATATION_RES } from 'ee_jest/ai/tanuki_bot/mock_data';

Vue.use(VueApollo);

const MOCK_VULNERABILITY_ID = 1;

describe('Explain Vulnerability component', () => {
  let wrapper;

  const chatMutationHandlerMock = jest.fn().mockResolvedValue(MOCK_TANUKI_BOT_MUTATATION_RES);

  const createWrapper = ({ stubs } = {}) => {
    const apolloProvider = createMockApollo([[chatMutation, chatMutationHandlerMock]]);

    wrapper = shallowMountExtended(ExplainVulnerability, {
      propsData: { vulnerabilityId: MOCK_VULNERABILITY_ID },
      stubs,
      apolloProvider,
    });
  };

  const findExplainVulnerabilityButton = () => wrapper.findByTestId('try-button');
  const clickExplainVulnerabilityButton = () => findExplainVulnerabilityButton().vm.$emit('click');

  beforeEach(createWrapper);

  it('shows a "GlCard" with the expected title', () => {
    expect(wrapper.findComponent(GlCard).text()).toContain(
      'Explain this vulnerability and how to mitigate it with AI',
    );
  });

  it('shows the "Explain vulnerability" button with the expected text and icon', () => {
    expect(findExplainVulnerabilityButton().text()).toBe('Explain vulnerability');
    expect(findExplainVulnerabilityButton().props('icon')).toBe('tanuki-ai');
  });

  describe('when the "Explain vulnerability" button is clicked', () => {
    it('opens the global DuoChat drawer', () => {
      expect(helpCenterState.showTanukiBotChatDrawer).toBe(false);

      clickExplainVulnerabilityButton();

      expect(helpCenterState.showTanukiBotChatDrawer).toBe(true);
    });

    it('calls a custom chat mutation with the correct prompt and resource-id', () => {
      expect(chatMutationHandlerMock).not.toHaveBeenCalled();

      clickExplainVulnerabilityButton();

      expect(chatMutationHandlerMock).toHaveBeenCalledWith({
        question: '/vulnerability_explain',
        resourceId: `gid://gitlab/Vulnerability/${MOCK_VULNERABILITY_ID}`,
      });
    });
  });
});
