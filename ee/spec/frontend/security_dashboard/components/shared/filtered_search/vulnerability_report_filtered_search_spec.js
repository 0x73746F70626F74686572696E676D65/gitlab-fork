import { GlFilteredSearch } from '@gitlab/ui';
import { mountExtended } from 'helpers/vue_test_utils_helper';
import FilteredSearch from 'ee/security_dashboard/components/shared/filtered_search/vulnerability_report_filtered_search.vue';
import StatusToken from 'ee/security_dashboard/components/shared/filtered_search/tokens/status_token.vue';
import SeverityToken from 'ee/security_dashboard/components/shared/filtered_search/tokens/severity_token.vue';
import eventHub from 'ee/security_dashboard/components/shared/filtered_search/event_hub';
import { OPERATORS_OR } from '~/vue_shared/components/filtered_search_bar/constants';

describe('Vulnerability Report Filtered Search component', () => {
  let wrapper;

  const findFilteredSearchComponent = () => wrapper.findComponent(GlFilteredSearch);

  const createWrapper = () => {
    wrapper = mountExtended(FilteredSearch, {
      stubs: {
        QuerystringSync: true,
      },
    });
  };

  beforeEach(() => {
    createWrapper();
  });

  it('should mount the component with the correct config', () => {
    const filteredSearch = findFilteredSearchComponent();

    expect(filteredSearch.props('placeholder')).toEqual('Search or filter vulnerabilities...');

    expect(filteredSearch.props('value')).toEqual([
      {
        type: 'state',
        value: {
          data: StatusToken.DEFAULT_VALUES,
          operator: '||',
        },
      },
    ]);

    expect(filteredSearch.props('availableTokens')).toEqual([
      {
        type: 'state',
        title: 'Status',
        multiSelect: true,
        unique: true,
        token: StatusToken,
        operators: OPERATORS_OR,
      },
      {
        type: 'severity',
        title: 'Severity',
        multiSelect: true,
        unique: true,
        token: SeverityToken,
        operators: OPERATORS_OR,
      },
    ]);
  });

  it('should propagate when event hub emits a `filters-changed` event', () => {
    const eventObj = { state: ['DISMISSED'] };
    eventHub.$emit('filters-changed', eventObj);
    expect(wrapper.emitted('filters-changed')).toEqual([[eventObj]]);
  });
});
