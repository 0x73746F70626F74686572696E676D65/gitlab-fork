# frozen_string_literal: true

require "spec_helper"

RSpec.describe Gitlab::VulnerabilityScanning::ContainerScanning::FindingBuilder, feature_category: :software_composition_analysis do
  let(:now) { Time.zone.now }
  let(:ci_build) { build(:ci_build) }
  let(:sbom_source) { build(:ci_reports_sbom_source) }
  let(:security_scanner) { Gitlab::VulnerabilityScanning::SecurityScanner.fabricate }

  let(:affected_component) do
    build(:vs_possibly_affected_component, name: 'Bind 9',
      version: '9.0.1')
  end

  let(:advisory) do
    build(:vs_advisory,
      title: "bind: assertion failure in buffer.c while building responses to a specifically constructed request",
      description: "buffer.c in named in ISC BIND 9 before 9.9.9-P3, 9.10.x before 9.10.4-P3, and 9.11.x",
      cvss_v2: "AV:N/AC:L/Au:N/C:N/I:N/A:C",
      cvss_v3: "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
      urls: %w[http://rhn.redhat.com/errata/RHSA-2016-1944.html http://rhn.redhat.com/errata/RHSA-2016-1945.html http://rhn.redhat.com/errata/RHSA-2016-2099.html],
      identifiers: [
        build(:pm_identifier, type: "cve", name: "CVE-2018-1000538",
          url: "https://nvd.nist.gov/vuln/detail/CVE-2018-1000538", value: "CVE-2018-1000538")
      ],
      solution: 'Update Bind Daemon'
    )
  end

  subject(:builder) do
    described_class.new(project: ci_build.project, pipeline: ci_build.pipeline, sbom_source: sbom_source,
      scanner: security_scanner, advisory: advisory, affected_component: affected_component)
  end

  describe "#finding" do
    let(:finding) { builder.finding }

    context "when cyclonedx sbom contains required gitlab:container_scanning properties" do
      let(:sbom_source) do
        build(:ci_reports_sbom_source, :container_scanning, image_name: 'rhel', image_tag: '7.1',
          operating_system_name: 'Red Hat Enterprise Linux', operating_system_version: '7')
      end

      it "does not add any errors to the report" do
        expect { builder.finding }.not_to raise_error
      end

      it "creates the links" do
        expect(finding.links).to match_array([
          have_attributes(url: "http://rhn.redhat.com/errata/RHSA-2016-1944.html"),
          have_attributes(url: "http://rhn.redhat.com/errata/RHSA-2016-1945.html"),
          have_attributes(url: "http://rhn.redhat.com/errata/RHSA-2016-2099.html")
        ])
      end

      it "creates the name" do
        expect(finding.name).to eq(advisory.title)
      end

      it "creates the description" do
        expect(finding.description).to eq(advisory.description)
      end

      it "creates the solution" do
        expect(finding.solution).to eq("Update Bind Daemon")
      end

      it "creates a valid location" do
        expect(finding.location).to have_attributes(
          image: 'rhel:7.1',
          operating_system: 'Red Hat Enterprise Linux 7',
          package_name: 'Bind 9',
          package_version: '9.0.1')
      end

      it "creates the severity" do
        expect(finding.severity).to eq("high")
      end

      it "creates the confidence" do
        expect(finding.confidence).to eq("unknown")
      end

      it "creates the metadata version" do
        expect(finding.metadata_version).to eq("0.0.0")
      end
    end

    context "when cyclonedx does not contain required gitlab:container_scanning properties" do
      using RSpec::Parameterized::TableSyntax

      where(:image_name, :image_tag) do
        'rhel' | nil
        nil    | '7.1'
        nil    | nil
      end

      with_them do
        let(:sbom_source) do
          build(:ci_reports_sbom_source, :container_scanning, image_name: image_name, image_tag: image_tag)
        end

        it "adds an error to the generated report" do
          expect do
            builder.finding
          end.to raise_error(described_class::MissingPropertiesError,
            "Missing required gitlab:container_scanning CycloneDX properties")
        end
      end
    end
  end
end
