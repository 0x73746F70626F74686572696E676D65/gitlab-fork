# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Gitlab::Llm::ResponseModifiers::ResolveVulnerability, feature_category: :vulnerability_management do
  let(:ai_response) { nil }

  subject(:response_modifier) { described_class.new(ai_response) }

  shared_examples_for 'empty response error' do
    it 'parses content from the ai response' do
      expect(response_modifier.response_body).to eq('')
    end

    it 'returns empty errors' do
      expect(response_modifier.errors).to match_array("The response from the AI provider was empty.")
    end
  end

  context 'when no ai_response is passed' do
    it_behaves_like 'empty response error'
  end

  context 'when empty hash is passed' do
    let(:ai_response) { {}.to_json }

    it_behaves_like 'empty response error'
  end

  context 'when bo merge request reference is passed' do
    let(:reference) { nil }
    let(:ai_response) { { 'merge_request_reference' => reference }.to_json }

    it 'parses content from the ai response' do
      expect(response_modifier.response_body).to eq('')
    end

    it 'returns empty errors' do
      expect(response_modifier.errors).to match_array("No resolution merge request reference was provided")
    end
  end

  context 'when a merge request reference is passed' do
    let(:reference) { "!1" }
    let(:ai_response) { { 'merge_request_reference' => reference }.to_json }

    it 'parses content from the ai response' do
      expect(response_modifier.response_body).to eq(reference)
    end

    it 'returns empty errors' do
      expect(response_modifier.errors).to be_empty
    end
  end
end
